{"mappings":"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","sources":["src/main.js"],"sourcesContent":["const { nowInSec, SkyWayAuthToken, SkyWayContext, SkyWayRoom, SkyWayStreamFactory, uuidV4 } = skyway_room;\n\nwindow.onload = async function () {\n    await SkyWay_main(String(Token));\n}\n\nconst Token = new SkyWayAuthToken({\n    jti: uuidV4(),\n    iat: nowInSec(),\n    exp: nowInSec() + 60 * 60 * 24 * 3,\n    scope: {\n        app: {\n            id: \"7dc26499-2433-43ec-8285-99beff41a46b\",\n            turn: true,\n            actions: ['read'],\n            channels: [\n                {\n                    id: '*',\n                    name: '*',\n                    actions: ['write'],\n                    members: [\n                        {\n                            id: '*',\n                            name: '*',\n                            actions: ['write'],\n                            publication: {\n                                actions: ['write'],\n                            },\n                            subscription: {\n                                actions: ['write'],\n                            },\n                        },\n                    ],\n                    sfuBots: [\n                        {\n                            actions: ['write'],\n                            forwardings: [\n                                {\n                                    actions: ['write'],\n                                },\n                            ],\n                        },\n                    ],\n                },\n            ],\n        },\n    },\n}).encode(\"ektEwMWo27esBj8OPysenv96493Rh9Ze0wOAVa3ott4=\");\n\nfunction SkyWay_main(token) {\n    const { SkyWayAuthToken, SkyWayContext, SkyWayRoom, SkyWayStreamFactory } = skyway_room;\n\n    (async () => {\n        const buttonArea = document.getElementById('button-area');\n        const remoteMediaArea = document.getElementById('remote-media-area');\n        const roomNameInput = \"transceiver\";\n\n        let Members = 1;\n\n        const myId = document.getElementById('my-id');\n        const myName = document.getElementById('my-name');\n        const Memberselem = document.getElementById('Members');\n        const IdDisp = document.getElementById('id-disp');\n        const joinButton = document.getElementById('join');\n        const userNameInput = document.getElementById('user-name');\n\n        const target = document.getElementById('MuteInfo');\n        const NonMutebtn = document.getElementById('NonMute-btn');\n        const leavebtn = document.getElementById('leave');\n\n        let isMuted = true;\n\n        const userPositions = {};\n\n        joinButton.onclick = async () => {\n            const userName = userNameInput.value.trim();\n            if (userName === '') {\n                alert('名前を入力してください');\n                return;\n            }\n\n            userPositions[userName] = { x: 0, y: 0, z: 0 };\n\n            const audio = await SkyWayStreamFactory.createMicrophoneAudioStream();\n\n            if (roomNameInput === '') return;\n\n            const context = await SkyWayContext.Create(token);\n            const room = await SkyWayRoom.FindOrCreate(context, {\n                type: 'p2p',\n                name: roomNameInput,\n            });\n            const me = await room.join({ name: userName });\n\n            const publication = await me.publish(audio);\n\n            console.log(`${userName} is connected`);\n\n            target.textContent = \"ミュート解除中\";\n            NonMutebtn.style.backgroundColor = \"rgb(147, 235, 235)\";\n\n            myId.textContent = me.id;\n            myName.textContent = userName;\n            Memberselem.textContent = Members + \"人\";\n            IdDisp.style.visibility = \"visible\";\n\n            NonMutebtn.style.visibility = \"visible\";\n            NonMutebtn.style.opacity = 1;\n            joinButton.style.visibility = \"hidden\";\n            leavebtn.style.visibility = \"visible\";\n\n            leavebtn.onclick = () => {\n                me.leave();\n                location.reload();\n            };\n\n            NonMutebtn.addEventListener('click', async () => {\n                isMuted = !isMuted;\n                if (isMuted) {\n                    target.textContent = \"ミュート中\";\n                    NonMutebtn.style.backgroundColor = \"red\";\n                    await publication.disable();\n                } else {\n                    target.textContent = \"ミュート解除中\";\n                    NonMutebtn.style.backgroundColor = \"rgb(147, 235, 235)\";\n                    await publication.enable();\n                }\n            });\n\n            const subscribeAndAttach = (publication) => {\n                if (publication.publisher.id === me.id) return;\n\n                const subscribeButton = document.createElement('button');\n                subscribeButton.textContent = `${publication.publisher.name || publication.publisher.id}: ${publication.contentType}`;\n                buttonArea.appendChild(subscribeButton);\n\n                subscribeButton.onclick = async () => {\n                    const { stream } = await me.subscribe(publication.id);\n\n                    let newMedia;\n                    switch (stream.track.kind) {\n                        case 'audio':\n                            newMedia = document.createElement('audio');\n                            newMedia.controls = true;\n                            newMedia.autoplay = true;\n                            newMedia.setAttribute('data-username', publication.publisher.name || publication.publisher.id); // ユーザー名をデータ属性として設定\n                            break;\n                        default:\n                            return;\n                    }\n                    stream.attach(newMedia);\n                    remoteMediaArea.appendChild(newMedia);\n\n                    setInterval(async () => {\n                        try {\n                            const response = await fetch('http://is-lecture.gl.at.ply.gg:26473/getPositions');\n                            const positions = await response.json();\n                            console.log('Received positions:', positions);\n\n                            for (const [name, position] of Object.entries(positions)) {\n                                if (userPositions[name]) {\n                                    userPositions[name] = position;\n                                } else {\n                                    // 位置情報がない場合はデフォルト値を設定\n                                    userPositions[name] = { x: 0, y: 0, z: 0 };\n                                }\n\n                                const mediaElement = document.querySelector(`[data-username=\"${name}\"]`);\n                                if (mediaElement) {\n                                    adjustVolume(mediaElement, userPositions[myName.textContent], userPositions[name]);\n                                }\n                            }\n                        } catch (error) {\n                            console.error('Failed to fetch positions:', error);\n                        }\n                    }, 500); // 0.5秒ごとに位置情報を取得\n                };\n\n                subscribeButton.click();\n                Members++;\n                Memberselem.textContent = Members + \"人\";\n            };\n\n            me.onPublicationUnsubscribed.add(() => {\n                Members--;\n                Memberselem.textContent = Members + \"人\";\n            });\n\n            room.publications.forEach(publication => {\n                const publisherName = publication.publisher.name || publication.publisher.id;\n                if (!userPositions[publisherName]) {\n                    userPositions[publisherName] = { x: 0, y: 0, z: 0 };\n                }\n                subscribeAndAttach(publication);\n            });\n\n            room.onStreamPublished.add((e) => {\n                const publisherName = e.publication.publisher.name || e.publication.publisher.id;\n                if (!userPositions[publisherName]) {\n                    userPositions[publisherName] = { x: 0, y: 0, z: 0 };\n                }\n                subscribeAndAttach(e.publication);\n            });\n\n            await publication.enable();\n        };\n    })();\n}\n\nnavigator.permissions.query({ name: 'microphone' }).then((result) => {\n    if (result.state === 'granted') {\n        console.log(\"マイクを利用します\");\n    } else {\n        console.log(\"マイクの権限取得エラーです\");\n        alert(\"マイクを使用する権限を与えて下さい\");\n    }\n});\n\nfunction calculateDistance(pos1, pos2) {\n    return Math.sqrt(\n        Math.pow(pos1.x - pos2.x, 2) +\n        Math.pow(pos1.y - pos2.y, 2) +\n        Math.pow(pos1.z - pos2.z, 2)\n    );\n}\n\nfunction adjustVolume(mediaElement, pos1, pos2) {\n    const distance = calculateDistance(pos1, pos2);\n    const maxDistance = 10; // 最大距離\n    const minVolume = 0; // 最小音量\n    const volume = Math.max(minVolume, 1 - (distance / maxDistance));\n    mediaElement.volume = volume;\n    console.log(`Volume adjusted for ${mediaElement.getAttribute('data-username')}: ${volume}`);\n}\n"],"names":[],"version":3,"file":"index.de158e3a.js.map","sourceRoot":"/__parcel_source_root/"}